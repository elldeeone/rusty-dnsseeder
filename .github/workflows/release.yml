name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            os: linux
            arch: x86_64
            target: x86_64-unknown-linux-gnu
            target_dir: target/x86_64-unknown-linux-gnu/release
            bin_ext: ""
            archive: dnsseeder-linux-x86_64.tar.gz
            needs_linker: "false"
          - runner: ubuntu-latest
            os: linux
            arch: arm64
            target: aarch64-unknown-linux-gnu
            target_dir: target/aarch64-unknown-linux-gnu/release
            bin_ext: ""
            archive: dnsseeder-linux-arm64.tar.gz
            needs_linker: "true"
          - runner: macos-15-intel
            os: darwin
            arch: x86_64
            target: x86_64-apple-darwin
            target_dir: target/x86_64-apple-darwin/release
            bin_ext: ""
            archive: dnsseeder-darwin-x86_64.tar.gz
            needs_linker: "false"
          - runner: macos-15
            os: darwin
            arch: arm64
            target: aarch64-apple-darwin
            target_dir: target/aarch64-apple-darwin/release
            bin_ext: ""
            archive: dnsseeder-darwin-arm64.tar.gz
            needs_linker: "false"
          - runner: windows-latest
            os: windows
            arch: x86_64
            target: x86_64-pc-windows-msvc
            target_dir: target/x86_64-pc-windows-msvc/release
            bin_ext: ".exe"
            archive: dnsseeder-windows-x86_64.zip
            needs_linker: "false"

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: false
          cache-bin: "false"
          cache-all-crates: "false"
          cache-workspace-crates: "false"
          add-job-id-key: "false"
          add-rust-environment-hash-key: "false"
          prefix-key: dnsseeder
          key: ${{ runner.os }}-${{ matrix.target || 'native' }}-release
          save-if: ${{ github.ref == 'refs/heads/master' }}

      - name: Install protoc
        uses: arduino/setup-protoc@v3

      - name: Install cross linker
        if: matrix.needs_linker == 'true'
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build dnsseeder
        shell: bash
        run: |
          set -e
          if [ "${{ matrix.needs_linker }}" = "true" ]; then
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          fi
          cargo build --release --target "${{ matrix.target }}"

      - name: Package (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          mkdir -p dist
          cp "${{ matrix.target_dir }}/dnsseeder${{ matrix.bin_ext }}" "dist/dnsseeder${{ matrix.bin_ext }}"
          tar -czf "dist/${{ matrix.archive }}" -C dist "dnsseeder${{ matrix.bin_ext }}"

      - name: Package (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item "${{ matrix.target_dir }}/dnsseeder${{ matrix.bin_ext }}" "dist/dnsseeder${{ matrix.bin_ext }}"
          Push-Location dist
          Compress-Archive -Path "dnsseeder${{ matrix.bin_ext }}" -DestinationPath "../dist/${{ matrix.archive }}" -Force
          Pop-Location

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ matrix.archive }}

  docker-build:
    name: docker-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Set image name (lowercase)
        shell: bash
        run: echo "IMAGE_NAME=ghcr.io/${GITHUB_REPOSITORY,,}" >> "$GITHUB_ENV"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ !contains(github.ref_name, '-') }}

      - name: Build and push (by digest)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,push-by-digest=true,name=${{ env.IMAGE_NAME }}
          cache-from: type=gha,scope=docker-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=docker-${{ matrix.arch }}

      - name: Export digest
        shell: bash
        run: echo "${{ steps.build.outputs.digest }}" > digest-${{ matrix.arch }}.txt

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digest-${{ matrix.arch }}
          path: digest-${{ matrix.arch }}.txt
          if-no-files-found: error

  docker-manifest:
    name: docker-manifest
    runs-on: ubuntu-latest
    needs: docker-build
    permissions:
      contents: read
      packages: write
    steps:
      - name: normalize image name
        shell: bash
        run: echo "IMAGE_NAME=ghcr.io/${GITHUB_REPOSITORY,,}" >> "$GITHUB_ENV"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ !contains(github.ref_name, '-') }}

      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          pattern: digest-*
          merge-multiple: true

      - name: Create and push manifest
        shell: bash
        run: |
          set -euo pipefail
          image="${{ env.IMAGE_NAME }}"
          digests=()
          for f in digest-*.txt; do
            digests+=("${image}@$(cat "$f")")
          done
          tags="${{ steps.meta.outputs.tags }}"
          for tag in $tags; do
            docker buildx imagetools create -t "$tag" "${digests[@]}"
          done
